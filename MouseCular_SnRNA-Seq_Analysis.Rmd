---
title: "Ultimate_SnRNA"
author: "Hugues Escoffier"
output: html_document
---

# snRNA-seq 

The sequencing data preprocessing steps, including base calling, mapping and read counting, have been done using Cell Ranger. 
Based on Zhisong He & Barbara Treutlein Analysis (https://github.com/quadbiolab)

## 0. Set Up 

### 0.1 Libraries 

```{r}
# CRAN 
library(Seurat)
library(SeuratDisk)
library(circlize)
library(harmony)
library(dplyr)
library(tidyr)
library(tidyverse)
library(patchwork)
library(stats)
library(ggplot2)
library(ggrepel)
library(tibble)
library(monocle3)
library(SeuratWrappers)
library(clustree)
library(anndata)
library(reticulate)
library(renv)
library(hrbrthemes)
# BioConductor 
library(destiny)
library(ComplexHeatmap)
library(biomaRt)
library(DESeq2)
library(scran)
# Devtools 
library(presto)
library(nichenetr)
library(loomR)
library(chorddiag)
library(nichenetr)
library(multinichenetr)
```

### 0.2 Palettes 

```{r}
matisse <- c("#D6BCC0", "#FFCD00", "#009BDE", "#FF5733", "#8B1A1A", "#81C784", "#FA8072", "#009688", "#F44336", "#FFA07A", "#3F51B5", "#F9A8D4", "#006400", "#BA55D3", "#6600FF")
stepped <- c("#990f26", "#b33e52", "#cc7a88", "#e6b8bf", "#99600f", "#b3823e", "#ccaa7a", "#e6d2b8", "#54990f", "#78b33e", "#a3cc7a", "#cfe6b8", "#0f8299", "#3e9fb3", "#7abecc", "#b8dee6", "#3d0f99", "#653eb3", "#967acc", "#c7b8e6", "#333333", "#666666")
laputa <- c('#403369FF', "#AE93BEFF", "#B4DAE5FF", "#F0D77BFF")
seurat_palette <- c('#E77E72', '#D98A36', '#C59833', '#A9A334', '#87AD33', '#73B134', '#56BB70', '#56BE9C', '#55BCC2', '#52B5E2', '#4BA6F8', '#8793F8',  '#BD7FF8', '#DC70E6', '#ED6CC7', '#ED72A0')
```

## 1. Create Seurat Object 

```{r}
counts <- Read10X(data.dir = "data/Ctl-D/outs/filtered_feature_bc_matrix")
seurat.rna <- CreateSeuratObject(counts$`Gene Expression`, project="D2") # if snRNA & snATAC-Seq data
# seurat.rna <- CreateSeuratObject(counts, project="D2") # if snRNA-Seq data 
```

```{r}
# Check the number of nuclei in the data 
md <- seurat.rna@meta.data %>% as.data.table
md[, .N, by = c("orig.ident")]
```

## 2. Quality Control 
We filter : 
* Cells with too few genes detected. _(representing cells which are not sequenced deep enough)_
* Cells with too many genes detected. _(corresponding to multiplets)_
* Cells with high mitochondrial transcript percentage.

```{r}
# Add mitochondrial transcript percentage
seurat.rna[["percent.mt"]] <- PercentageFeatureSet(seurat.rna, pattern = "^mt-")
# Visualize 
VlnPlot(seurat.rna, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size=0)
FeatureScatter(seurat.rna, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(seurat.rna, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
# The number of detected genes and number of detected transcripts are well correlated across cells while mitochondrial transcript percentage is not.
```

```{r}
# Same thresholds as Lin et al. 
seurat.rna <- subset(seurat.rna, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 0.8)
```

## 3. Normalization 
Since the amount of captured RNA can vary between cells, it is not appropriate to compare the number of captured transcripts for individual genes directly. To ensure that gene expression levels can be accurately compared across different cells, it is necessary to perform a normalization step. This step is aimed at making gene expression levels between cells comparable.

```{r}
seurat.rna <- NormalizeData(seurat.rna)
```

## 4. Feature selection
Identification of highly variable features/genes, which are genes with the most varied expression levels across cells.

```{r}
# There are no defined values in the literature. Generally we choose values between 2000 and 5000. The results do not differ significantly between these values. 
seurat.rna <- FindVariableFeatures(seurat.rna, nfeatures = 3000)
```

```{r}
# Visualize
top_features <- head(VariableFeatures(seurat.rna), 20)
plot1 <- VariableFeaturePlot(seurat.rna)
plot1
LabelPoints(plot = plot1, points = top_features, repel = TRUE)
```

## 5. Scaling 
If no data transformation is performed, the analysis could be biased towards highly expressed genes since different genes have varying base expression levels and distributions. This is an undesirable outcome as we want our analysis to consider all genes equally. To address this issue, we apply scaling to the data using selected features, which is a common practice in various data science fields. This ensures that the contribution of each gene to the analysis is appropriately accounted for, regardless of their expression levels.

```{r}
seurat.rna <- ScaleData(seurat.rna, vars.to.regress = c("nFeature_RNA", "percent.mt")) # Remove unwanted sources of variation
```

## 3-5. SCTransform 
Steps 3 to 5 can be replaced by a `SCTransform` step

```{r}
seurat.rna <- SCTransform(seurat.rna,
                      vars.to.regress = c("nFeature_RNA", "percent.mt"),
                      variable.features.n = 3000)
```

## 6. PCA

```{r}
seurat.rna <- RunPCA(seurat.rna, npcs = 50)
ElbowPlot(seurat.rna, ndims = ncol(Embeddings(seurat.rna, "pca")))
```

One would assume that the first phase of the curve represents the 'real' signal related to biological differences between cell populations, while the second phase mostly represents technical variation or the stochastic nature of individual cells.
* It is very difficult to precisely define the elbow point or turning point of the curve, as it is usually not a perfect elbow.
* Higher-ranked PCs do explain more variation than lower-ranked PCs, but more explained variations does not necessarily mean higher information content. Sometimes there is interesting but weak signal buried in the noise and therefore as part of lower-ranked PCs.

## 7. Non-linear dimension reduction 
TSNE provides great visualization when cells form distinct cell groups, while UMAP perserves trajectory-like structure better when data contains 'continuum'.

```{r}
seurat.rna <- RunTSNE(seurat.rna, dims = 1:15)
seurat.rna <- RunUMAP(seurat.rna, dims = 1:15)

TSNEPlot(seurat.rna)
UMAPPlot(seurat.rna)
```

```{r}
FeaturePlot(seurat.rna, c("Myh1","Myh2","Myh4","Myh7","Xist","Uty","Col22a1","Pam","Ttn"),
ncol=3, reduction = "tsne")
FeaturePlot(seurat.rna, c("Myh1","Myh2","Myh4","Myh7","Xist","Uty","Col22a1","Pam","Ttn"),
ncol=3, reduction = "umap")
```

## Save 

```{r}
saveRDS(seurat.rna, file="save/seurat_ctl_pl")
```

## 8. Integration 
Benchmarking of integration tools : 
* A benchmark of batch-effect correction methods for single-cell RNA sequencing data (https://doi.org/10.1186/s13059-019-1850-9)
* Benchmarking atlas-level data integration in single-cell genomics (https://doi.org/10.1038/s41592-021-01336-8)

### 8.0 Load 

```{r}
seurat_ctl <- readRDS("save/seurat_ctl")
seurat_denerv <- readRDS("save/seurat_denerv")
seurat_d2 <- readRDS("save/seurat_d2")
seurat_teno <- readRDS("save/seurat_teno")
seurat_ctl_pl <- readRDS("save/seurat_ctl_pl")
# seurat_gastroc <- readRDS("save/GSE183802_snRNA-seq_data_CTL_and_denervation.rds")
# seurat.rna <- seurat_gastroc
```

### 8.1 Merge

```{r}
seurat.merge <- merge(seurat_ctl, c(seurat_denerv, seurat_d2, seurat_ctl_pl)) %>%
# seurat.merge <- merge(seurat_ctl_pl, c(seurat_teno)) %>%
  FindVariableFeatures(nfeatures = 3000) %>%
  ScaleData() %>%
  RunPCA(npcs = 50) %>%
  RunUMAP(dims = 1:20)

# OPTION : Rename 
seurat.merge$orig.ident[seurat.merge$orig.ident == "Ctl"] <- "Ctl-TA"
seurat.merge$orig.ident[seurat.merge$orig.ident == "Ctl-Pl"] <- "Ctl-Pltr"
seurat.merge$orig.ident[seurat.merge$orig.ident == "D2"] <- "D-Pltr"
seurat.merge$orig.ident[seurat.merge$orig.ident == "Denerv"] <- "D-TA"

DimPlot(seurat.merge, group.by="orig.ident", cols = matisse) & NoAxes()
FeaturePlot(seurat.merge, c("Myh1","Myh2","Myh4","Musk"), ncol=2, pt.size = 0.1) & NoAxes()
```

### 8.2-A Using Seurat 
_(https://doi.org/10.1016/j.cell.2019.05.031)_
/!\ Seurat's integration create a new assay 

```{r}
seurat_objs <- list(seurat_ctl, seurat_denerv, seurat_d2, seurat_ctl_pl) # Add every datasets 
anchors <- FindIntegrationAnchors(object.list = seurat_objs, dims = 1:30)
seurat.integrate <- IntegrateData(anchors, dims = 1:30)
```

```{r}
seurat.integrate <- ScaleData(seurat.integrate)
seurat.integrate <- RunPCA(seurat.integrate, npcs = 50)
ElbowPlot(seurat.integrate, ndims = ncol(Embeddings(seurat.integrate, "pca")))
```

```{r}
seurat.integrate <- RunUMAP(seurat.integrate, dims = 1:20)
```

```{r}
DefaultAssay(seurat.integrate) <- "RNA"
UMAPPlot(seurat.integrate, group.by="orig.ident")
FeaturePlot(seurat.integrate, c("Myh1","Myh2","Myh4","Col22a1"), ncol=2)
```

### 8.2-B Using Harmony 
_(https://doi.org/10.1038/s41592-019-0619-0)_

```{r}
seurat.harm <- merge(seurat_ctl, c(seurat_denerv, seurat_d2, seurat_ctl_pl)) %>%
  FindVariableFeatures(nfeatures = 3000) %>%
  ScaleData() %>%
  RunPCA(npcs = 50)

seurat.harm <- RunHarmony(seurat.harm, group.by.vars = "orig.ident", dims.use = 1:25, max.iter.harmony = 50)
seurat.harm <- RunUMAP(seurat.harm, reduction = "harmony", dims = 1:25)
ElbowPlot(seurat.harm, ndims = ncol(Embeddings(seurat.harm, "pca")))
```

```{r}
DefaultAssay(seurat.harm) <- "RNA"
UMAPPlot(seurat.harm, group.by="orig.ident") & NoAxes()
FeaturePlot(seurat.harm, c("Myh1","Myh2","Myh4","Musk"), ncol=2) & NoAxes()
```

```{r}
saveRDS(seurat.integrate, file="save/seurat_4integrate")
```

## 9. Clustering 

```{r}
# seurat.rna <- seurat.integrate # if integrate with seurat
seurat.rna <- seurat.harm # if integrate with harmony

seurat.rna <- ScaleData(object = seurat.rna, features = rownames(seurat.rna))

# OPTION : Rename 
seurat.rna$orig.ident[seurat.rna$orig.ident == "Ctl"] <- "Ctl-TA"
seurat.rna$orig.ident[seurat.rna$orig.ident == "Ctl-Pl"] <- "Ctl-Pltr"
seurat.rna$orig.ident[seurat.rna$orig.ident == "D2"] <- "D-Pltr"
seurat.rna$orig.ident[seurat.rna$orig.ident == "Denerv"] <- "D-TA"

# Add type
seurat.rna$status <- NA 
seurat.rna$status[seurat.rna$orig.ident == "Ctl-TA"] <- "Control"
seurat.rna$status[seurat.rna$orig.ident == "Ctl-Pltr"] <- "Control"
seurat.rna$status[seurat.rna$orig.ident == "D-Pltr"] <- "Denervated"
seurat.rna$status[seurat.rna$orig.ident == "D-TA"] <- "Denervated"
seurat.rna$status[seurat.rna$orig.ident == "T-Pltr"] <- "Tenotomy"

# Add muscle
seurat.rna$muscle <- NA 
seurat.rna$muscle[seurat.rna$orig.ident == "Ctl-TA"] <- "TA"
seurat.rna$muscle[seurat.rna$orig.ident == "Ctl-Pltr"] <- "Pltr"
seurat.rna$muscle[seurat.rna$orig.ident == "D-Pltr"] <- "Pltr"
seurat.rna$muscle[seurat.rna$orig.ident == "D-TA"] <- "TA"
```

```{r}
seurat.rna <- FindNeighbors(seurat.rna, dims = 1:ncol(Embeddings(seurat.rna)), reduction = "harmony")
seurat.rna <- FindClusters(seurat.rna, resolution = 0.6, algorithm = 1) # algorithm = 1 -> Lauvain / 4 -> Leiden
```

```{r}
# Clustree 
resolution.range <- seq(from = 0, to = 2, by = 0.2)
seurat.rna.clustree <- FindClusters(object = seurat.rna, resolution = resolution.range)
head(seurat.rna.clustree@meta.data)
clustree(seurat.rna.clustree, prefix = 'RNA_snn_res.') # Change according to the metadata
```

```{r}
# Vizualize the data 
DimPlot(seurat.rna, reduction = "umap", label = TRUE) & NoAxes() # Normal 
DimPlot(seurat.rna, reduction = "umap", group.by = "orig.ident", label = FALSE, cols=matisse) & NoAxes() 
UMAPPlot(seurat.rna, group.by="orig.ident", split.by = "orig.ident", cols=matisse, ncol=2)  & NoAxes()
DimPlot(seurat.rna, reduction = "umap", group.by = "status", split.by ="status", label = FALSE) & NoAxes() 
DimPlot(seurat.rna, reduction = "umap", group.by="muscle", label = FALSE, cols = c("#1E488F", "#FF6F61")) & NoAxes() 

# Expression Plot 
FeaturePlot(seurat.rna, c("Tenm2", "Gpc6", "Bnc2","Ebf2"), ncol = 2) & NoAxes() & NoLegend()
FeaturePlot(seurat.rna, c("Eno3"))
VlnPlot(seurat.rna, features = c("Stxbp4", "Aldh1a1", "Cep85l","Ppara"), pt.size = 0, ncol = 2)
FeaturePlot(seurat.rna, features = c("Myh1", "Myh2"), blend = TRUE, ncol = 2) # Bof 

# Co-expression 
FeatureScatter(seurat.rna, feature1 = "Myh2", feature2 = "Myh4", slot = "counts")
FeatureScatter(seurat.rna, feature1 = "Myh4", feature2 = "Myh1", slot = "counts", group.by = "muscle", cols = seurat_palette)
```

```{r}
# Subset 
seurat.rna_denervated <- subset(seurat.rna, subset = RNA_snn_res.0.6 %in% c(7,3))
seurat.rna_heal <- subset(seurat.rna, subset = RNA_snn_res.0.6 %in% c(0,6,2))
```

## 10. Annotate cells 

```{r}
# Top Marker for each cluster
DefaultAssay(seurat.rna) <- "RNA"
input_data.markers <- FindAllMarkers(seurat.rna, min.pct = 0.25, logfc.threshold = 0.25, only.pos = TRUE)
input_data.markers %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
input_data.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_log2FC) -> topX
DoHeatmap(seurat.rna, features = topX$gene, group.colors = stepped, hjust = 0, raster = FALSE, lines.width = 5, size = 3) + NoLegend()
```

### 10.1 Tenotomy 

```{r}
# ANNOTATION FOR TENOTOMY DATA 
seurat.rna$gtype <- factor(setNames(c("IIb",
                                       "IIx",
                                       "IIb",
                                       "FAPs",
                                       "FAPs",
                                       "IIa",
                                       "Macrophages",
                                       "Tenocytes",
                                       "FAPs",
                                       "SmoothM",
                                       "IIb",
                                       "Adipocytes",
                                       "C_Ribo",
                                       "MuSC",
                                       "MTJ",
                                       "Other",
                                       "Other",
                                       "Other",
                                      "NMJ",
                                      "SmoothM"),
                                 levels(seurat.rna@active.ident))[seurat.rna@active.ident],
                        levels=c("IIx","IIa", "IIb", "MTJ", "NMJ", "FAPs", "Macrophages","SmoothM", "Tenocytes", "MuSC", "Adipocytes", "Other", "C_Ribo"))
seurat.rna <- subset(seurat.rna, subset = RNA_snn_res.0.9 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19))
```

```{r}
DimPlot(seurat.rna, reduction = "umap", group.by = "gtype", label = T) & NoAxes()
```

```{r}
# Number of cells in clusters 
md <- seurat.rna@meta.data %>% as.data.table
md[, .N, by = c("seurat_clusters")]
```

### 10.2 Denervation 

```{r}
# Annotation for all clusters 
seurat.rna$celltype <- setNames(rep(c("IIb",
                                      "C_Ribo",
                                      "IIx_1",
                                      "D_IIb_1",
                                      "FAPs",
                                      "IIa",
                                      "IIx_2",
                                      "D_IIb_2",
                                      "Macrophage",
                                      "SmoothM",
                                      "Tenocytes",
                                      "MTJ",
                                      "Endothelial",
                                      "MuSC",
                                      "NMJ",
                                      "O_1",
                                      "O_2",
                                      "Adipocytes"), c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)), 
                                c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17))[as.character(seurat.rna$RNA_snn_res.0.6)]
```

```{r}
# Annotation per 'Group' 
seurat.rna$gtype <- factor(setNames(c("IIb",
                                      "C_Ribo",
                                      "IIx",
                                      "D_IIb",
                                      "FAPs",
                                      "IIa",
                                      "IIx",
                                      "D_IIx",
                                      "Macrophages",
                                      "SmoothM",
                                      "Tenocytes",
                                      "MTJ",
                                      "Endothelial",
                                      "MuSC",
                                      "NMJ",
                                      "Other",
                                      "Other",
                                      "Adipocytes"),
                                 levels(seurat.rna@active.ident))[seurat.rna@active.ident],
                        levels=c("IIx","IIa", "IIb", "D_IIb", "D_IIx", "MTJ", "NMJ", "FAPs", "Macrophages","SmoothM", "Tenocytes", "Endothelial", "MuSC", "Adipocytes", "Other", "C_Ribo"))

DimPlot(seurat.rna, reduction = "umap", group.by = "gtype", cols = seurat_palette, label = T) & NoAxes()
```

```{r}
# Annotation Muscular/Non muscular
seurat.rna$gtype_muscular <- factor(setNames(c("IIb",
                                       "C_Ribo",
                                       "IIx",
                                       "D_IIb",
                                       "Non-muscular",
                                       "IIa",
                                       "IIx",
                                       "D_IIx",
                                       "Non-muscular",
                                       "Non-muscular",
                                       "Non-muscular",
                                       "MTJ",
                                       "Non-muscular",
                                       "Non-muscular",
                                       "NMJ",
                                       "Non-muscular",
                                       "Non-muscular",
                                       "Non-muscular"),
                                 levels(seurat.rna@active.ident))[seurat.rna@active.ident],
                        levels=c("IIx","IIa", "IIb", "D_IIb", "D_IIx", "MTJ", "NMJ", "Non-muscular", "C_Ribo"))

DimPlot(seurat.rna, reduction = "umap", group.by = "gtype_muscular", label = T, cols = seurat_palette) & NoAxes()
```

```{r}
# Subset without C_Ribo
seurat.rna <- subset(seurat.rna, subset = RNA_snn_res.0.6 %in% c(0,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17))
```

```{r}
# Number of cells in gtype
md <- seurat.rna@meta.data %>% as.data.table
md[, .N, by = c("gtype")]
```

## 11. Composition
Check the difference between two conditions is the composition of cell types or cell states. 

### 11.1 Visualize the compostions 

```{r}
DefaultAssay(seurat.rna) <- "RNA"
freq <- table(seurat.rna$gtype, seurat.rna$status) # you can change 'status' by 'muscle'
prop <- apply(freq,2,function(x) x/sum(x))

layout(matrix(1:3,nrow=1)); par(mar=c(8,5,1,1))
barplot(freq, col=colors <- seurat_palette, # colors 
        border=NA, las=2, ylab="Frequency", cex.names = 0.8)
barplot(prop, col=colors <- seurat_palette,
        border=NA, las=2, ylab="Proportion", cex.names = 0.8)
plot.new()
legend("left", fill=seurat_palette, legend=rownames(freq), bty="n")
```

### 11.2-A Composition Comparaison using Fisher  
The odds ratio shows the degree of enrichment (>1) or depletion (<1)

```{r}
freq_fisher <- function(conditions, have_identity){
  freq <- table(factor(have_identity, levels=c(TRUE,FALSE)),
              conditions)
  test <- fisher.test(freq)
  res <- setNames(c(test$estimate, test$p.value), c("oddsratio","pval_fisher"))
  return(res)
}

region_enrichment <- data.frame(region = levels(seurat.rna$gtype),
                                t(sapply(levels(seurat.rna$gtype), function(gtype)
                                  freq_fisher(conditions = factor(seurat.rna$status, levels=c("C","D")),
                                              have_identity = seurat.rna$gtype == gtype)
                                  )),
                                row.names=NULL)
region_enrichment$padj_fisher <- p.adjust(region_enrichment$pval_fisher)
region_enrichment
```

### 11.2-B Composition Comparaison using GLM  
Fisher's exact test does not take into account replicate information. GLM is going to take account of these information

```{r}
freq_glm_aov <- function(samples, conditions, have_identity){
  sample_conditions <- unique(data.frame(sample = samples, condition = conditions))
  sample_conditions <- setNames(sample_conditions$condition, sample_conditions$sample)
  freq <- table(samples, factor(have_identity, levels=c(TRUE,FALSE)))
  m <- glm(freq ~ sample_conditions[rownames(freq)], family = "binomial")
  aov <- anova(m, test = "Chisq")
  res <- setNames(c(coef(m)[2], aov$Pr[2]), c("coef_glm","pval_aov"))
  return(res)
}

region_enrichment <- data.frame(region_enrichment,
                                t(sapply(levels(seurat.rna$gtype), function(gtype){
                                freq_glm_aov(samples = seurat.rna$orig.ident,
                                             conditions = factor(seurat.rna$status, levels=c("C","D")),
                                             seurat.rna$gtype == seurat.rna$celltype)
                                  })),
                                row.names=NULL)
region_enrichment$padj_aov <- p.adjust(region_enrichment$pval_aov)
region_enrichment
# write.csv(region_enrichment, "GLM_Comparaison.csv", row.names=FALSE) # save the result as a csv file 
```

Show the proportion of each region in each sample separately

```{r}
org_status <- unique(data.frame(muscle=seurat.rna$muscle,
                                status=factor(seurat.rna$status, levels=c("Control","Denervated"))))
org_status <- setNames(org_status$status, org_status$orig.ident)

layout(matrix(1:6,nrow=1))

for(gtype in c("IIx","IIa", "IIb", "D_IIb", "D_IIx", "NMJ", "FAPs", "Other", "Unclassified")){
  props <- setNames(sapply(sort(unique(seurat.rna$orig.ident)), function(orig.ident)
    mean(seurat.rna$gtype[seurat.rna$orig.ident == orig.ident] == gtype)),
    sort(unique(seurat.rna$orig.ident)))
  barplot(props[order(props)],
          col = ifelse(org_status[names(props)[order(props)]] == "Control", "#cdcdcd", "#303030"),
          ylab = "Proportions", main = gtype, las = 2, cex.names = 0.8)
  }

plot.new()
legend("left", fill = c("#cdcdcd","#303030"), legend = c("C","D"), bty="n")
```

```{r}
test <- unique(data.frame(muscle=seurat.rna$muscle,
                            status=factor(seurat.rna$muscle, levels=c("Pltr","TA"))))
test <- setNames(test$status, test$status)

layout(matrix(1:4,nrow=1))

for(gtype in c("IIa","IIb","D_IIb", "IIx", 'D_IIx', 'Non-muscular')){
  props <- setNames(sapply(sort(unique(seurat.rna$muscle)), function(muscle)
    mean(seurat.rna$gtype[seurat.rna$muscle == muscle] == gtype)),
    sort(unique(seurat.rna$muscle)))
  barplot(props[order(props)],
          col = ifelse(test[names(props)[order(props)]] == "Pltr", "#cdcdcd", "#303030"),
          ylab = "Proportions", main = gtype, las = 2, cex.names = 0.8)
}

plot.new()
legend("left", fill = c("#cdcdcd","#303030"), legend = c("Control","Denervated"), bty="n")
```

##  12. Differential Expression 

### 12.1 Transcriptome similarity 
Compare the general transcriptome similarities of the same cell type/state in different samples or conditions in order to get general information whether there exists any substantial transcriptomic changes in this cell type/state between conditions.

```{r}
seurat_transcriptome <- subset(seurat.rna, subset = gtype == "IIa") %>% # for cluster IIa 
  FindVariableFeatures()
avg_expr_org <- sapply(sort(unique(seurat.rna$orig.ident)), function(org)
  rowMeans(seurat_transcriptome@assays$RNA@data[,which(seurat_transcriptome$orig.ident == org)]))
corr_org <- cor(avg_expr_org[VariableFeatures(seurat_transcriptome),])
plot(hclust(as.dist(1-corr_org)))
```

### 12.2 Wilcoxon test for DE
Possibility of using Seurat's FindMarker() function for identical results 

```{r}
DE_wilcoxauc_transcriptome <- wilcoxauc(seurat_transcriptome, group_by = "status") %>%
  dplyr::filter(group == "D") %>%
  mutate(DE = abs(logFC)>log(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(abs(logFC)>log(1.1) & padj < 0.01, feature, NA))

DE_wilcoxauc_transcriptome
# write.csv(DE_wilcoxauc_transcriptome, "IPA/wilcox_IIx.csv", row.names=FALSE) # save the result for IPA 

ggplot(DE_wilcoxauc_transcriptome, aes(x = logFC, y = -log10(padj), col=DE, label=DEG)) +
  geom_point() +
  geom_text_repel() +
  geom_vline(xintercept=c(-log(1.1), log(1.1), 0), col="#303030", linetype="dotted") +
  geom_hline(yintercept=-log10(0.01), col="#303030", linetype="dotted") +
  scale_color_manual(values=c("#909090", "red")) +
  theme_minimal()
```

### 12.3 DESeq2 for DE 
Possibility of using Seurat's FindMarker() function for identical results 

```{r}
det_rate <- rowMeans(seurat_transcriptome@assays$RNA@data)
meta <- seurat_transcriptome@meta.data %>% mutate(status = factor(status, levels=c("C","D")))
dds <- DESeqDataSetFromMatrix(seurat_transcriptome@assays$RNA@counts[det_rate > 0.05,],
                              colData=meta,
                              design = ~ status)

sizeFactors(dds) <- calculateSumFactors(seurat_transcriptome@assays$RNA@counts[det_rate > 0.05,])
dds <- DESeq(dds, test="LRT", reduced=~1, useT=TRUE, minmu=1e-6, minReplicatesForReplace=Inf)
DE_deseq2_transcriptome <- results(dds) %>% as.data.frame() %>%
  tibble::rownames_to_column("gene") %>%
  mutate(DE = abs(log2FoldChange)>log2(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(abs(log2FoldChange)>log2(1.1) & padj < 0.01, gene, NA))

DE_deseq2_transcriptome
# write.csv(DE_deseq2_transcriptome, "IPA/DESeq_IIx.csv", row.names=FALSE)

ggplot(DE_deseq2_transcriptome, aes(x = log2FoldChange, y = -log10(padj), col=DE, label=DEG)) +
  geom_point() +
  geom_text_repel(max.overlaps = 20) + head(seurat.rna@meta.data)

  geom_vline(xintercept=c(-log2(1.1), log2(1.1), 0), col="#303030", linetype="dotted") +
  geom_hline(yintercept=-log10(0.01), col="#303030", linetype="dotted") +
  scale_color_manual(values=c("#909090", "red")) +
  theme_minimal()
```

### 12.3 GLM for DE 
Possibility of using Seurat's FindMarker() function for identical results 

```{r}
# Use log-normalized data as the input assumes a normal distribution. 
aov_DE <- function(expr, cond, covar = NULL, family = "gaussian", test = NULL){
  if (is.null(covar)) covar <- data.frame(X_const = 1)
  dat <- data.frame(y = expr,
                    cond = cond,
                    covar)
  m <- glm(y ~ ., family = family, data = dat)
  m0 <- glm(y ~ . - cond, family = family, data = dat)
  if (is.null(test)){
    test <- "F"
    if (ifelse(is(family, "family"), family$family, family) %in% c("binomial","poisson"))
      test <- "Chisq"
  }
  aov <- anova(m, m0, test = test)
  res <- c(coef(m)[grep("^cond",names(coef(m)))], aov$Pr[2])
  names(res)[length(res)] <- "pval"
  return(res)
}

DE_aov <- data.frame(t(sapply(which(det_rate > 0.05), function(i)
  aov_DE(expr = seurat_transcriptome@assays$RNA@data[i,],
         cond = factor(seurat_transcriptome$status, levels=c("C","D")),
         covar = data.frame(cov = log10(seurat_transcriptome$nCount_RNA))))), row.names=NULL)

DE_aov$padj <- p.adjust(DE_aov$pval, method="BH")
DE_aov <- data.frame(gene = names(which(det_rate > 0.05)), DE_aov) %>%
  mutate(DE = abs(condD)>log(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(abs(condD)>log(1.1) & padj < 0.01, gene, NA))

DE_aov_bin <- data.frame(t(sapply(which(det_rate > 0.05), function(i)
  aov_DE(expr = seurat_transcriptome@assays$RNA@data[i,] > 0,
         cond = factor(seurat_transcriptome$status, levels=c("C","D")),
         covar = data.frame(cov = seurat_transcriptome$nCount_RNA),
         family = "binomial"))), row.names=NULL)

DE_aov_bin$padj <- p.adjust(DE_aov_bin$pval, method="BH")
DE_aov_bin <- data.frame(gene = names(which(det_rate > 0.05)), DE_aov_bin) %>%
  mutate(DE = padj < 0.01) %>%
  mutate(DEG = ifelse(padj < 0.01, gene, NA))

DE_aov
DE_aov_bin

ggplot(DE_aov, aes(x = condD, y = -log10(padj), col=DE, label=DEG)) +
  geom_point() +
  geom_text_repel(max.overlaps = 20) +
  geom_vline(xintercept=c(-log(1.1), log(1.1), 0), col="#303030", linetype="dotted") +
  geom_hline(yintercept=-log10(0.01), col="#303030", linetype="dotted") +
  scale_color_manual(values=c("#909090", "red")) +
  theme_minimal()

ggplot(DE_aov_bin, aes(x = condD, y = -log10(padj), col=DE, label=DEG)) +
  geom_point() +
  geom_text_repel(max.overlaps = 20) +
  geom_vline(xintercept=0, col="#303030", linetype="dotted") +
  geom_hline(yintercept=-log10(0.01), col="#303030", linetype="dotted") +
  scale_color_manual(values=c("#909090", "red")) +
  theme_minimal()
```

### 12.4 FindMarkers for DE 

```{r}
cluster.markers1 <- FindMarkers(seurat.rna, ident.1 = 'Control', group.by = "status", subset.ident = "IIa", min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
cluster.markers2 <- FindMarkers(seurat.rna, ident.1 = 'Denervated', group.by = "status", subset.ident = "IIa", min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
top30 <- head(cluster.markers1, n=30)
top30.2 <- head(cluster.markers2, n=30)
DoHeatmap(seurat.rna, features = c(rownames(top30),rownames(top30.2)))
write.csv(cluster.markers, "IPA/FM_IIa_vs_TIIa_oP_F.csv", row.names = TRUE)
DoHeatmap(object = seurat.rna, features = cluster.markers)
cluster.markers <- FindMarkers(seurat.rna, ident.1 = 'Control', group.by = "status", subset.ident = c("IIb_1", "IIb_2", "IIb_3"), min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
write.csv(cluster.markers, "IPA/FM_IIb_vs_TIIb_oP_F.csv", row.names = TRUE)
cluster.markers <- FindMarkers(seurat.rna, ident.1 = 'Control', group.by = "status", subset.ident = "IIx", min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
write.csv(cluster.markers, "IPA/FM_IIx_vs_TIIx_oP_F.csv", row.names = TRUE)

# write.csv(cluster.markers, "IPA/FM_Mix_vs_DMix_oP_T.csv", row.names = TRUE)
# cluster.markers <- FindMarkers(seurat.rna, ident.1 = 'IIb', ident.2 = "D_IIb", min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
# write.csv(cluster.markers, "IPA/FM_IIb_vs_DIIb_oP_F.csv", row.names = TRUE)
# cluster.markers <- FindMarkers(seurat.rna, ident.1 = 'IIb', ident.2 = "D_IIb", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# write.csv(cluster.markers, "IPA/FM_IIb_vs_DIIb_oP_T.csv", row.names = TRUE)
# cluster.markers <- FindMarkers(seurat.rna, ident.1 = c('IIx_1', 'IIx_2'), ident.2 = "D_IIx", min.pct = 0.25, logfc.threshold = 0.25, only.pos = F)
# write.csv(cluster.markers, "IPA/FM_IIx_vs_DIIx_oP_F.csv", row.names = TRUE)
# cluster.markers <- FindMarkers(seurat.rna, ident.1 = c('IIx_1', 'IIx_2'), ident.2 = "D_IIx", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# write.csv(cluster.markers, "IPA/FM_IIx_vs_DIIx_oP_T.csv", row.names = TRUE)
```

Vizualize the results as a Heatmap  

```{r}
# Select the clusters you want to visualize in the heatmap
seurat.subset.heatmap <- subset(seurat.rna, subset = RNA_snn_res.0.6 %in% c(0,3))

cluster.markers1 <- FindMarkers(seurat.rna, ident.1 = 'IIb', ident.2 = "D_IIb", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# cluster.markers1 <- FindMarkers(seurat.rna, ident.1 = 'Control', group.by = "status", subset.ident = "IIa", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# cluster.markers1 <- FindMarkers(seurat.rna, ident.1 = 'Control', group.by = "status", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
cluster.markers1 %>% slice_max(n = 20, order_by = avg_log2FC)

cluster.markers2 <- FindMarkers(seurat.rna, ident.1 = 'D_IIb', ident.2 = "IIb", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# cluster.markers2 <- FindMarkers(seurat.rna, ident.1 = 'Denervated', group.by = "status", subset.ident = "IIa", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
# cluster.markers2 <- FindMarkers(seurat.rna, ident.1 = 'Tenotonmy', group.by = "status", min.pct = 0.25, logfc.threshold = 0.25, only.pos = T)
cluster.markers2 %>% slice_max(n = 20, order_by = avg_log2FC)

top20_cluster1 <- head(cluster.markers1, n=20)
top20_cluster2 <- head(cluster.markers2, n=20)

DoHeatmap(subset(seurat.subset.heatmap, downsample = 200), features = c(rownames(top20_cluster1),rownames(top20_cluster2)), group.by = 'status')
```

## 13. Trajectory Analysis 

### 13.1 Cluster connectivity analysis
PAGA approach is based on the clustering results and evaluate the strength of connectivity between every two clusters. (DOI?)

```{r}
# Convert seurat (R) to scanpy (Python) 
cell_attrs <- list(pca = Embeddings(seurat.rna,"pca")[,1:20],
                   umap = Embeddings(seurat.rna,"umap"),
                   celltype = seurat.rna@meta.data$gtype) # Group by gtype 
loom <- loomR::create("save/loom_rna_final2.loom",
                      data = seurat.rna[['RNA']]@data,
                      layers = list(counts = seurat.rna[['RNA']]@counts),
                      cell.attrs = cell_attrs)
loom$close_all()
```

```{r}
# Convert seurat (R) to scanpy (Python) 
adata <- AnnData(X = t(seurat.rna[['RNA']]@data),
                 obs = data.frame(celltype = seurat.rna@gtype, row.names = colnames(seurat.rna)),
                 var = seurat.rna[['RNA']]@meta.features,
                 layers = list(counts = t(seurat.rna[['RNA']]@counts)),
                 obsm = list(pca = Embeddings(seurat.rna,"pca")[,1:20],
                             umap = Embeddings(seurat.rna,"umap"))
                )
adata$write_h5ad("save/anndata_rna_type_final2.h5ad")
```

```{r}
# Import packages
py_install("scanpy", pip=T)
py_install("igraph", pip=T)
py_install("numpy", pip=T)
plt <- import("matplotlib")
sc <- import("scanpy")
```

```{r}
# adata.rna <- sc$read("save/anndata_rna_type.h5ad") # you can use .h5ad or .loom, the result are the same 
adata.rna <- sc$read_loom("save/loom_rna_final2.loom") 
sc$pp$neighbors(adata.rna, n_neighbors=20L, use_rep='pca')
sc$tl$paga(adata.rna, groups='celltype')
adata.rna$write_h5ad("save/loom_rna_final2.loom")
```

```{r}
plt$use("Agg", force = TRUE)
sc$pl$paga(adata.rna,
           color='celltype',
           fontsize=7,
           frameon=FALSE,
           threshold=0.2, # Change 
           node_size_scale = 4,
           save="rna_paga.png")
```

### 13.2 Using Destiny 

```{r}
dm <- DiffusionMap(Embeddings(seurat.rna, "pca")[,1:20]) # Better if perform on a subset
dpt <- DPT(dm)
seurat.type$dpt <- rank(dpt$dpt) # or (-dpt$dpt)
FeaturePlot(seurat.type, c("dpt", "Myh4", "Runx1", "Dlg2"), ncol=2)
```

Visualize expression changes along the constructed pseudotime

```{r}
plot1 <- qplot(seurat.type$dpt, as.numeric(seurat.type@assays$RNA@data["Myh4",]),
               xlab="Dpt", ylab="Expression", main="Myh4") +
  geom_smooth(se = FALSE, method = "loess") + theme_bw()
plot2 <- qplot(seurat.type$dpt, as.numeric(seurat.type@assays$RNA@data["Runx1",]),
               xlab="Dpt", ylab="Expression", main="Runx1") +
  geom_smooth(se = FALSE, method = "loess") + theme_bw()
plot3 <- qplot(seurat.type$dpt, as.numeric(seurat.type@assays$RNA@data["Cntfr",]),
               xlab="Dpt", ylab="Expression", main="Cntfr") +
  geom_smooth(se = FALSE, method = "loess") + theme_bw()
plot1
plot2
plot3
```

### 13.3 Using Monocle3

```{r}
seurat.rna.cds <- as.cell_data_set(seurat.rna, reduction = 'umap')
seurat.rna.cds <- cluster_cells(cds = seurat.rna.cds, reduction_method = "UMAP")
seurat.rna.cds <- learn_graph(seurat.rna.cds, use_partition = TRUE)
seurat.rna.cds <- order_cells(seurat.rna.cds, reduction_method = "UMAP", root_cells = NULL)

plot_cells(seurat.rna.cds, color_cells_by = "status", cell_size = 0.5, group_label_size = 3, label_groups_by_cluster = F, label_leaves = FALSE, label_branch_points = FALSE, graph_label_size = 5)
plot_cells(seurat.rna.cds, color_cells_by = "gtype", cell_size = 0.5, label_groups_by_cluster = FALSE, label_leaves = FALSE, label_branch_points = FALSE, graph_label_size = 0)

rowData(seurat.rna.cds)$gene_name <- rownames(seurat.rna.cds)
rowData(seurat.rna.cds)$gene_short_name <- rowData(seurat.rna.cds)$gene_name

plot_cells(seurat.rna.cds, color_cells_by = "pseudotime", cell_size = 0.5, label_groups_by_cluster = FALSE, label_leaves = FALSE, label_branch_points = FALSE, graph_label_size = 4)
```

## 14. MultiNicheNet 

```{r}
lr_network = readRDS(url("https://zenodo.org/record/7074291/files/lr_network_mouse_21122021.rds"))
  lr_network = lr_network %>% dplyr::rename(ligand = from, receptor = to) %>% distinct(ligand, receptor) %>% mutate(ligand = make.names(ligand), receptor = make.names(receptor))
  ligand_target_matrix = readRDS(url("https://zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final_mouse.rds"))
  colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% make.names()
  rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% make.names()
```

```{r}
#C onvert you Seurat Object 
sce = Seurat::as.SingleCellExperiment(seurat.rna, assay = "RNA")
sce = alias_to_symbol_SCE(sce, "mouse") %>% makenames_SCE()
```

```{r}
SummarizedExperiment::colData(sce)$orig.ident = SummarizedExperiment::colData(sce)$orig.ident %>% make.names()
```

```{r}
sample_id = "orig.ident"
group_id = "status"
celltype_id = "gtype"
covariates = NA
batches = NA
```

```{r}
senders_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
receivers_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
```

```{r}
min_cells = 10
abundance_expression_info = get_abundance_expression_info(sce = sce, sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, min_cells = min_cells, senders_oi = senders_oi, receivers_oi = receivers_oi, lr_network = lr_network, batches = batches)
```

```{r}
# Vizualize in a R file 
abundance_expression_info$abund_plot_sample
```

```{r}
contrasts_oi = c("'Control-Denervated','Denervated-Control'")
contrast_tbl = tibble(contrast = c("Control-Denervated","Denervated-Control"), group = c("Control","Denervated"))
DE_info = get_DE_info(sce = sce, sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, batches = batches, covariates = covariates, contrasts_oi = contrasts_oi, min_cells = min_cells)
DE_info$celltype_de$de_output_tidy %>% arrange(p_adj)
celltype_de = DE_info$celltype_de$de_output_tidy

```

```{r}
sender_receiver_de = combine_sender_receiver_de(
  sender_de = celltype_de,
  receiver_de = celltype_de,
  senders_oi = senders_oi,
  receivers_oi = receivers_oi,
  lr_network = lr_network
)
sender_receiver_de
```

NicheNet Analysis 

```{r}
ligand_activities_targets_DEgenes = suppressMessages(suppressWarnings(get_ligand_activities_targets_DEgenes(
  receiver_de = celltype_de,
  receivers_oi = receivers_oi,
  ligand_target_matrix = ligand_target_matrix,
  logFC_threshold = 0.5,
  p_val_threshold = 0.05,
  p_val_adj = F,
  top_n_target = 250,
  verbose = T, 
  n.cores = min(8, sender_receiver_de$receiver %>% unique() %>% length()) # 8 cores 
)))
```

```{r}
ligand_activities_targets_DEgenes$de_genes_df %>% head(20)
ligand_activities_targets_DEgenes$ligand_activities %>% head(20)
```

```{r}
prioritizing_weights_DE = c("de_ligand" = 1, "de_receptor" = 1)
prioritizing_weights_activity = c("activity_scaled" = 2)
prioritizing_weights_expression_specificity = c("exprs_ligand" = 2, "exprs_receptor" = 2)
prioritizing_weights_expression_sufficiency = c("frac_exprs_ligand_receptor" = 1)
prioritizing_weights_relative_abundance = c( "abund_sender" = 0, "abund_receiver" = 0)

prioritizing_weights = c(prioritizing_weights_DE, 
                         prioritizing_weights_activity, 
                         prioritizing_weights_expression_specificity,
                         prioritizing_weights_expression_sufficiency, 
                         prioritizing_weights_relative_abundance)

sender_receiver_tbl = sender_receiver_de %>% dplyr::distinct(sender, receiver)
metadata_combined = SummarizedExperiment::colData(sce) %>% tibble::as_tibble()

grouping_tbl = metadata_combined[,c(sample_id, group_id)] %>% tibble::as_tibble() %>% dplyr::distinct()
colnames(grouping_tbl) = c("sample","group")
```

```{r}
prioritization_tables = suppressMessages(generate_prioritization_tables(
  sender_receiver_info = abundance_expression_info$sender_receiver_info,
  sender_receiver_de = sender_receiver_de,
  ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
  contrast_tbl = contrast_tbl,
  sender_receiver_tbl = sender_receiver_tbl,
  grouping_tbl = grouping_tbl,
  prioritizing_weights = prioritizing_weights,
  fraction_cutoff = 0.05, 
  abundance_data_receiver = abundance_expression_info$abundance_data_receiver,
  abundance_data_sender = abundance_expression_info$abundance_data_sender
))
```

```{r}
prioritization_tables$group_prioritization_tbl %>% head(20)
```

```{r}
# ERROR ? 
lr_target_prior_cor = lr_target_prior_cor_inference(prioritization_tables$group_prioritization_tbl$receiver %>% 
                                                      unique(), abundance_expression_info, celltype_de, grouping_tbl, prioritization_tables, ligand_target_matrix, logFC_threshold = 0.5, p_val_threshold = 0.05, p_val_adj = F)
```

```{r}
multinichenet_output = list(
    celltype_de = celltype_de,
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de =  sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    prioritization_tables = prioritization_tables,
    grouping_tbl = grouping_tbl #,
    # lr_target_prior_cor = lr_target_prior_cor
  ) 
multinichenet_output = make_lite_output(multinichenet_output)

saveRDS(multinichenet_output, "multinichenet_output.rds")
```

Visualization of the results of the cell-cell communication analysis

```{r}
# Top 50 predictions across all contrasts, senders and receiver
prioritized_tbl_oi_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, rank_per_group = FALSE)

prioritized_tbl_oi = multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  dplyr::filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()

colors_sender = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)
colors_receiver = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver) # PLOT
```

Visualization of scaled ligand-receptor pseudobulk products and ligand activity

```{r}
# Top 50 interactions specific for 'Denervated'
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = 'Denervated')

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50) # PLOT
plot_oi
```

```{r}
# With D_IIb as receiver 
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = "D_IIb")

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
plot_oi
```

